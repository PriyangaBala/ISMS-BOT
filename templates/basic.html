<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Professional ISMS & QMS Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
 :root {
  --primary-color: #1C1C1C;       /* Almost Black - for text & headers */
  --secondary-color: #4F4F4F;     /* Medium Gray - secondary text */
  --primary-light: #F2F2F2;       /* Soft White - backgrounds */
  --secondary-light: #BDBDBD;     /* Light Gray - borders, muted UI */
  --gradient: #FFD95B;            /* Subtle Yellow - accent */
  --gradient-light: #FFF3B0;      /* Lighter Yellow - hover, highlights */
}
 
    .chat-container {
      height: 100vh;
      background: #f0f0f0;
    }
 
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
 
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
 
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
 
    .animate-slideIn {
      animation: slideIn 0.3s ease-out;
    }
 
    .gradient-bg {
      background: var(--gradient);
    }
 
    .gradient-bg-light {
      background: var(--gradient-light);
    }
 
    .primary-color {
      color: var(--primary-color);
    }
 
    .secondary-color {
      color: var(--secondary-color);
    }
 
    .bg-primary {
      background-color: var(--primary-color);
    }
 
    .bg-secondary {
      background-color: var(--secondary-color);
    }
 
    .border-primary {
      border-color: var(--primary-color);
    }
 
    .border-secondary {
      border-color: var(--secondary-color);
    }
 
    /* Fix for textarea scrolling */
    .message-textarea {
      min-height: 60px;
      line-height: 1.5;
      background: #ffffff;
      backdrop-filter: blur(10px);
    }
 
    /* Card hover effects */
    .suggestion-card {
      transition: all 0.3s ease;
      background: #ffffff;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(51, 51, 51, 0.1);
    }
   
    .suggestion-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(51, 51, 51, 0.15);
      background: #fafafa;
      border-color: var(--primary-color);
    }
 
    .welcome-bg {
      background: #f0f0f0;
      min-height: 100vh;
    }
 
    .chat-header {
      background: var(--gradient);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0,0,0, 0.1);
    }
 
    .chat-input-container {
      background: #ffffff;
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(51, 51, 51, 0.1);
    }
 
    .user-message {
      background: var(--gradient);
      color: black;
      box-shadow: 0 4px 15px rgba(51, 51, 51, 0.3);
    }
 
    .bot-message {
      background: #ffffff;
      border: 1px solid rgba(51, 51, 51, 0.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
 
    .welcome-input {
      background: #ffffff;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(51, 51, 51, 0.2);
      transition: all 0.3s ease;
      resize: none !important;
    }
 
    .welcome-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(51, 51, 51, 0.1);
    }
 
    .icon-gradient {
      background: var(--gradient);
    }
 
    .text-gradient {
      color: black;
    }
 
    .status-online {
      color: #FFC700;
    }
 
    .typing-dots {
      background-color: var(--primary-color);
    }
 
    /* Header layout improvements */
    .header-container {
      display: flex;
      align-items: center;
      width: 100%;
      min-height: 4rem;
    }
 
    .header-title {
      font-weight: 700;
      font-size: 1.125rem;
      color: black;
      margin-left: 0.75rem;
    }
 
    /* Button improvements */
    .send-button {
      transition: all 0.2s ease;
    }
 
    .send-button:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 199, 0, 0.3);
    }
 
    .send-button:active:not(:disabled) {
      transform: scale(0.95);
    }
 
    /* Input focus improvements */
    .message-textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 199, 0, 0.1);
      outline: none;
    }
 
    /* Scrollbar styling */
    .messages-area {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 199, 0, 0.3) transparent;
    }
   
    .messages-area::-webkit-scrollbar {
      width: 6px;
    }
   
    .messages-area::-webkit-scrollbar-track {
      background: transparent;
    }
   
    .messages-area::-webkit-scrollbar-thumb {
      background: rgba(255, 199, 0, 0.3);
      border-radius: 20px;
    }
 
    .messages-area::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }
 
    /* Loading animation improvements */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
 
    .typing-dots {
      animation: pulse 1.5s ease-in-out infinite;
    }
 
    /* Enhanced content formatting */
    .formatted-content {
      line-height: 1.6;
    }
    
    .formatted-content h4 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .formatted-content .content-card {
      background: #f8f9fa;
      border-left: 4px solid var(--gradient);
      margin-bottom: 1rem;
      transition: all 0.2s ease;
    }
    
    .formatted-content .content-card:hover {
      background: #f1f3f4;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .back-button {
        left: 0.75rem;
      }
     
      .header-title {
        font-size: 1rem;
      }
     
      .suggestion-card {
        padding: 1rem;
      }
      
      .formatted-content .content-card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }
    }
  </style>
</head>
<body class="chat-container">
  <div class="chat-container flex flex-col">
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-bg flex-1 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-6xl w-full text-center">
        <div class="mb-8 animate-fadeIn">
          <h1 class="text-4xl md:text-5xl font-light text-gray-800 mb-2">
            Hi there, <span class="text-gradient font-medium">Welcome to Professional ISMS & QMS Assistant!</span>
          </h1>
          <h2 class="text-2xl md:text-3xl font-light primary-color">
            Your trusted companion for Information Security Management System and Quality Management System queries.
          </h2>
        </div>
       
        <!-- Suggestion Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 max-w-5xl mx-auto animate-slideIn">
          <!-- ISMS Policies -->
          <div class="suggestion-card rounded-xl p-4 cursor-pointer"
               onclick="startWithSuggestion('What are the key ISMS policies and procedures?')">
            <div class="w-10 h-10 icon-gradient rounded-lg flex items-center justify-center mb-3 mx-auto shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                   viewBox="0 0 24 24" stroke="black" stroke-width="2">
                <path d="M9 12l2 2 4-4m5.25-4.5H4.75A2.25 2.25 0 002.5 7.75v8.5A2.25 2.25 0 004.75 18.5h14.5a2.25 2.25 0 002.25-2.25v-8.5A2.25 2.25 0 0019.25 5.5z"/>
              </svg>
            </div>
            <h3 class="font-bold text-black mb-2 text-sm">ISMS Policies</h3>
            <p class="text-gray-600 text-xs">Information security policies & procedures</p>
          </div>

          <!-- QMS Standards -->
          <div class="suggestion-card rounded-xl p-4 cursor-pointer"
               onclick="startWithSuggestion('Explain ISO 9001 quality management standards')">
            <div class="w-10 h-10 icon-gradient rounded-lg flex items-center justify-center mb-3 mx-auto shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                   viewBox="0 0 24 24" stroke="black" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h3 class="font-bold text-black mb-2 text-sm">QMS Standards</h3>
            <p class="text-gray-600 text-xs">Quality management system guidelines</p>
          </div>

          <!-- Risk Assessment -->
          <div class="suggestion-card rounded-xl p-4 cursor-pointer"
               onclick="startWithSuggestion('How to conduct information security risk assessment?')">
            <div class="w-10 h-10 icon-gradient rounded-lg flex items-center justify-center mb-3 mx-auto shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                   viewBox="0 0 24 24" stroke="black" stroke-width="2">
                <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
              </svg>
            </div>
            <h3 class="font-bold text-black mb-2 text-sm">Security</h3>
            <p class="text-gray-600 text-xs">Why do we need Security?</p>
          </div>

          <!-- Compliance -->
          <div class="suggestion-card rounded-xl p-4 cursor-pointer"
               onclick="startWithSuggestion('What are the compliance requirements for ISMS and QMS?')">
            <div class="w-10 h-10 icon-gradient rounded-lg flex items-center justify-center mb-3 mx-auto shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                   viewBox="0 0 24 24" stroke="black" stroke-width="2">
                <path d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="font-bold text-black mb-2 text-sm">Compliance</h3>
            <p class="text-gray-600 text-xs">Regulatory & audit requirements</p>
          </div>
        </div>
       
        <div class="max-w-3xl mx-auto relative z-10 animate-fadeIn">
          <div class="relative">
            <textarea
              id="welcomeInput"
              placeholder="Ask me anything about ISMS or QMS..."
              class="welcome-input w-full rounded-2xl px-6 py-4 pr-14 resize-none shadow-lg focus:outline-none"
              rows="1"
            ></textarea>
            <button
              id="welcomeSendButton"
              onclick="sendWelcomeMessage()"
              class="send-button absolute right-3 bottom-3 w-8 h-8 gradient-bg text-white rounded-lg hover:gradient-bg-light transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
              disabled
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
 
    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden flex-1 flex flex-col">
      <!-- Chat Header -->
      <div class="chat-header px-6 py-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex items-center relative">
          <!-- Back Button -->
          <button onclick="resetChat()"
            class="back-button w-auto px-4 h-10 rounded-lg bg-white flex items-center justify-center
                   border border-gray-200 shadow-sm
                   hover:bg-gray-50 active:bg-gray-100 absolute left-0"
            style="z-index:2;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                 xmlns="http://www.w3.org/2000/svg" class="text-gray-700 mr-2">
              <path d="M19 12H5M12 19L5 12L12 5"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
          </button>
          <!-- Title -->
          <div class="flex-1 text-center">
            <div class="header-title inline-block">Professional ISMS & QMS Assistant</div>
          </div>
        </div>
      </div>
 
      <!-- Chat Messages -->
      <div id="chatMessages" class="messages-area flex-1 overflow-y-auto px-6 py-4 max-w-4xl mx-auto w-full space-y-6"></div>
 
      <!-- Typing Indicator -->
      <div id="typingIndicator" class="hidden px-6 max-w-4xl mx-auto w-full">
        <div class="flex items-start space-x-3 mb-4 animate-fadeIn">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-semibold text-sm text-gray-700">ISMS & QMS Assistant</span>
            </div>
            <div class="bot-message rounded-2xl rounded-tl-md px-4 py-3">
              <div class="flex space-x-1">
                <div class="w-2 h-2 typing-dots rounded-full"></div>
                <div class="w-2 h-2 typing-dots rounded-full" style="animation-delay: 0.2s;"></div>
                <div class="w-2 h-2 typing-dots rounded-full" style="animation-delay: 0.4s;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
 
      <!-- Chat Input -->
      <div class="chat-input-container px-6 py-4 sticky bottom-0">
        <div class="max-w-4xl mx-auto">
          <div class="relative">
            <textarea
              id="messageInput"
              placeholder="Type your ISMS or QMS question here..."
              class="message-textarea w-full border-2 border-gray-200 rounded-2xl px-6 py-4 pr-14 resize-none focus:outline-none focus:border-primary disabled:opacity-70 disabled:cursor-not-allowed shadow-sm"
              rows="1"
            ></textarea>
            <button
              id="sendButton"
              onclick="sendMessage()"
              class="send-button absolute right-3 bottom-4 w-8 h-8 gradient-bg text-white rounded-lg hover:gradient-bg-light transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
              disabled
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div> 
  <script
>
    const chatInterface = document.getElementById('chatInterface');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const welcomeInput = document.getElementById('welcomeInput');
    const welcomeSendButton = document.getElementById('welcomeSendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const welcomeScreen = document.getElementById('welcomeScreen');

    let isProcessing = false;

    function autoResizeWelcome() {
      welcomeInput.style.height = 'auto';
      welcomeInput.style.height = welcomeInput.scrollHeight + 'px';
      welcomeInput.style.overflowY = 'hidden';
      welcomeSendButton.disabled = !welcomeInput.value.trim();
    }

    function autoResize() {
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
      messageInput.style.overflowY = 'hidden';
     
      sendButton.disabled = !messageInput.value.trim() || isProcessing;
    }

    function startWithSuggestion(suggestion) {
      welcomeInput.value = suggestion;
      autoResizeWelcome();
      sendWelcomeMessage();
    }

    function switchToChat() {
      welcomeScreen.classList.add('hidden');
      chatInterface.classList.remove('hidden');
      messageInput.focus();
    }

    async function resetChat() {
        isProcessing = false;
        chatInterface.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
        chatMessages.innerHTML = '';
        welcomeInput.value = '';
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.style.overflowY = 'hidden';
        autoResizeWelcome();
        hideTypingIndicator();
        setTimeout(() => welcomeInput.focus(), 300);
        // Reset session on server
        await fetch('/reset', { method: 'POST' });
    }

    function extractAndRenderContent(response) {
      // Check if response already contains HTML
      if (/<[a-z][\s\S]*>/i.test(response)) {
        return response.replace(
          /<a\s+href="([^"]+)"[^>]*>(.*?)<\/a>/gi,
          `<a href="$1" target="_blank" class="text-blue-600 font-semibold hover:underline">$2</a>`
        );
      }
      
      let html = '';
      
      // Try to parse as JSON first
      try {
        const parsed = JSON.parse(response);
        if (typeof parsed === 'object' && parsed !== null) {
          if (parsed.title) html += `<h2 class="font-semibold text-lg primary-color mb-3">${parsed.title}</h2>`;
          if (parsed.description) html += `<div class="mb-4 text-gray-800 leading-relaxed">${parsed.description}</div>`;
          if (Array.isArray(parsed.sections)) {
            parsed.sections.forEach(section => {
              if (section.heading) html += `<h3 class="font-semibold text-md secondary-color mt-4 mb-2">${section.heading}</h3>`;
              if (section.content) html += `<div class="mb-3 text-gray-800 leading-relaxed">${section.content}</div>`;
              if (Array.isArray(section.bullet_points)) {
                html += '<ul class="list-disc pl-6 mb-4 space-y-1">';
                section.bullet_points.forEach(point => {
                  const formattedPoint = point.replace(/\*\*(.+?)\*\*/g, '<strong class="primary-color">$1</strong>');
                  html += `<li class="text-gray-700 leading-relaxed">${formattedPoint}</li>`;
                });
                html += '</ul>';
              }
            });
          }
          return html;
        }
      } catch (err) {
        // Not JSON, continue with text formatting
      }
      
      // Format plain text response with better structure
      let formattedText = response;
      
      // Convert **bold** to HTML bold
      formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
      
      // Convert numbered lists (1. 2. 3. etc.) to HTML ordered lists
      const numberedListRegex = /(\d+\.\s+\*\*[^*]+\*\*:?[^\n]*(?:\n(?!\d+\.)[^\n]*)*)/g;
      const numberedItems = formattedText.match(numberedListRegex);
      
      if (numberedItems && numberedItems.length > 0) {
        // Split content into sections
        const sections = formattedText.split(/(?=\d+\.\s+\*\*)/);
        let processedHtml = '';
        
        sections.forEach((section, index) => {
          if (index === 0 && !section.match(/^\d+\./)) {
            // This is intro text before the list
            processedHtml += `<div class="mb-4 text-gray-800 leading-relaxed">${section.trim()}</div>`;
          } else if (section.trim()) {
            // This is a numbered item
            const match = section.match(/^(\d+)\.\s+\*\*([^*]+)\*\*:?\s*(.*)/s);
            if (match) {
              const [, number, title, content] = match;
              processedHtml += `
                <div class="content-card p-4 rounded-lg">
                  <h4 class="font-semibold mb-2">${number}. ${title}</h4>
                  <p class="text-gray-700 leading-relaxed">${content.trim()}</p>
                </div>
              `;
            }
          }
        });
        
        html = `<div class="formatted-content">${processedHtml}</div>`;
      } else {
        // Handle bullet points and general formatting
        formattedText = formattedText
          // Convert URLs to links
          .replace(/(https?:\/\/[^\s]+)/gi, '<a href="$1" target="_blank" class="text-blue-600 font-semibold hover:underline">$1</a>')
          // Convert line breaks to proper spacing
          .replace(/\n\n/g, '</p><p class="mb-3 text-gray-800 leading-relaxed">')
          .replace(/\n/g, '<br>');
        
        html = `<div class="formatted-content text-gray-800 leading-relaxed"><p class="mb-3">${formattedText}</p></div>`;
      }
      
      return html || `<div class="text-gray-800 leading-relaxed whitespace-pre-wrap">${response}</div>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addMessage(message, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start space-x-3 animate-fadeIn';
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (isUser) {
        const escapedMessage = escapeHtml(message);
        messageDiv.innerHTML = `
          <div class="flex-1 flex flex-col items-end">
            <div class="user-message rounded-2xl rounded-tr-md px-6 py-4 max-w-2xl break-words">
              <p>${escapedMessage}</p>
            </div>
            <span class="text-xs text-gray-400 mt-2">${timestamp}</span>
          </div>
          <div class="w-8 h-8 bg-secondary rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
            <span class="text-white text-xs font-semibold">U</span>
          </div>
        `;
      } else {
        const contentHTML = extractAndRenderContent(message);
        messageDiv.innerHTML = `
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-semibold text-sm text-gray-700">ISMS & QMS Assistant</span>
              <span class="text-xs text-gray-400">${timestamp}</span>
            </div>
            <div class="bot-message rounded-2xl rounded-tl-md px-6 py-4 max-w-2xl">
              ${contentHTML}
            </div>
          </div>
        `;
      }
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function showTypingIndicator() {
      typingIndicator.classList.remove('hidden');
      scrollToBottom();
    }

    function hideTypingIndicator() {
      typingIndicator.classList.add('hidden');
    }

    function scrollToBottom() {
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
    }

    async function sendWelcomeMessage() {
      const message = welcomeInput.value.trim();
      if (!message || isProcessing) return;
      switchToChat();
      await processMessage(message);
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || sendButton.disabled || isProcessing) return;
      await processMessage(message);
    }

    function addBotMessage(content, isWebsite = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3 animate-fadeIn';
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (isWebsite) {
            // Disable previous charts
            const previousCharts = document.querySelectorAll('.chart-display-container');
            previousCharts.forEach(chart => {
                chart.classList.remove('chart-display-container');
                chart.innerHTML = '<div class="text-center text-gray-500 p-4">[Chart has been updated by a newer message]</div>';
            });

            messageDiv.innerHTML = `
              <div class="w-8 h-8 gradient-bg rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                <span class="text-white text-xs font-semibold">B</span>
              </div>
              <div class="flex-1">
                <div class="bot-message rounded-2xl rounded-tl-md px-6 py-4 max-w-2xl chart-display-container">
                  <iframe src="${content}" style="width:100%; height:400px; border:none; border-radius:12px;"></iframe>
                </div>
                <span class="text-xs text-gray-400 mt-2">${timestamp}</span>
              </div>
            `;
        } else {
            messageDiv.textContent = content;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function processMessage(message, isInitial = false) {
        isProcessing = true;
        sendButton.disabled = true;
        welcomeSendButton.disabled = true;
        messageInput.disabled = true;
        
        if (!isInitial) {
            addMessage(message, true);
            messageInput.value = '';
            autoResize();
        }
        
        showTypingIndicator();

        try {
            const response = await fetch('/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            hideTypingIndicator();
            addMessage(data.reply, false);

            if (data.image) {
                addBotMessage(data.image, true);
            }

        } catch (error) {
            console.error('Processing error:', error);
            hideTypingIndicator();
            addMessage('Sorry, there was an error processing your request. Please try again.', false);
        } finally {
            isProcessing = false;
            messageInput.disabled = false;
            sendButton.disabled = false;
            welcomeSendButton.disabled = !welcomeInput.value.trim();
            messageInput.focus();
            autoResize();
        }
    }

    function handleWelcomeKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (welcomeInput.value.trim() && !isProcessing) sendWelcomeMessage();
      }
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (messageInput.value.trim() && !sendButton.disabled && !isProcessing) sendMessage();
      }
    }

    // Event listeners
    welcomeInput.addEventListener('input', autoResizeWelcome);
    messageInput.addEventListener('input', autoResize);
    welcomeInput.addEventListener('keydown', handleWelcomeKeyDown);
    messageInput.addEventListener('keydown', handleKeyDown);

    // Initialize focus
    welcomeInput.focus();
  </script>
</body>
</html>